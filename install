#!/data/data/com.termux/files/usr/bin/bash

## https://github.com/adi1090x/termux-style

source ./tspp.config


## Directories
PREFIX='/data/data/com.termux/files/usr'
TERMUX_DIR="$HOME/.termux"
DIR="$(pwd)"

## Banner
banner () {
    clear
    echo "
    ${BLUE}TERMUX STYLE${RED}++
    ${ORANGE}INSTALLER"
}

## Script Termination
exit_on_signal_SIGINT () {
    { printf "\n\n%s\n" "    ${BLUE}[${RED}*${BLUE}] ${RED}Script interrupted." 2>&1; echo; reset_color; }
    exit 0
}

exit_on_signal_SIGTERM () {
    { printf "\n\n%s\n" "    ${BLUE}[${RED}*${BLUE}] ${RED}Script terminated." 2>&1; echo; reset_color; }
    exit 0
}

trap exit_on_signal_SIGINT SIGINT
trap exit_on_signal_SIGTERM SIGTERM

## Reset terminal colors
reset_color() {
	tput sgr0   # reset attributes
	tput op     # reset color
    return
}

## Prerequisite
prerequisite() {
	{ echo; echo "    ${BLUE}[${RED}*${BLUE}] ${ORANGE}Installing Dependencies..."${CYAN}; echo; }
	if [[ (-f $PREFIX/bin/wget) && (-f $PREFIX/bin/tput) ]]; then
		{ echo "    ${BLUE}[${RED}*${BLUE}] ${GREEN}Dependencies are already Installed!"; }
	else
		{ pkg update -y; pkg install -y git wget ncurses-utils; }
		(type -p wget tput &> /dev/null) && { echo; echo "    ${BLUE}[${RED}*${BLUE}] ${GREEN}Dependencies are succesfully installed!"; } || { echo; echo "    ${BLUE}[${RED}!${BLUE}] ${RED}Error Occured, failed to install dependencies."; echo; reset_color; exit 1; }
	fi
}

## Install termux-style
install_tspp () {
	echo "    ${BLUE}[${RED}*${BLUE}] ${ORANGE}Installing termux-stylepp..."
	# Delete old files
	if [[ (-L $PREFIX/bin/tspp) && (-d $PREFIX/share/tspp) ]]; then
		echo "    ${BLUE}[${RED}*${BLUE}] ${RED}Deleting files from previous installation..."${BLUE}
		{ rm -r $PREFIX/bin/tspp $PREFIX/share/tspp; echo; }
	fi
	# termux config dir
	if [[ ! -d $TERMUX_DIR ]]; then
		mkdir $TERMUX_DIR
	else
		cp -r $TERMUX_DIR{,.backup}
	fi
	# Coping files
	{ echo "    ${BLUE}[${RED}*${BLUE}] ${ORANGE}Coping files in ${GREEN}$PREFIX/share ${ORANGE}directory..."${BLUE}; }
	{ mkdir $PREFIX/share/tspp; cp -r $DIR/colors $PREFIX/share/tspp; cp -r $DIR/fonts $PREFIX/share/tspp; cp -r $DIR/tspp $PREFIX/share/tspp; cp -r $DIR/config $PREFIX/share/tspp; }
	{ chmod +x $PREFIX/share/tspp/tspp; ln -s $PREFIX/share/tspp/tspp $PREFIX/bin/tspp; }

	# Verify files 
	if [[ (-L $PREFIX/bin/tspp) && (-d $PREFIX/share/tspp) ]]; then
		{ echo; echo "    ${BLUE}[${RED}*${BLUE}] ${GREEN}Successfully Installed."; }
		{ echo "    ${BLUE}[${RED}*${BLUE}] ${GREEN}Now You Can Run This Program By Just typing ${MAGENTA}tspp${GREEN}."; echo; }
		{ reset_color; exit 0; }
	else
		{ echo "    ${BLUE}[${RED}!${BLUE}] ${RED}Error Occured."; echo; reset_color; exit 1; }
	fi
}

## Main
main () {
	banner
	prerequisite
	# Check for previous installation
	if [[ (-L $PREFIX/bin/tspp) && (-d $PREFIX/share/tspp) ]]; then
		{ echo; echo "    ${BLUE}[${RED}!${BLUE}] ${MAGENTA}termux-stylepp ${GREEN}is already installed."; }
		{ read -p "    ${BLUE}[${RED}?${BLUE}] ${ORANGE}Do you wanna re-install it? (y/n): ${GREEN}"; echo; }
		if [[ "$REPLY" =~ ^[y/Y]$ ]]; then
			install_tspp
		else
			{ reset_color; exit; }
		fi
	else
		{ echo; install_tspp; }
	fi
}

main
